<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Prueba Widget de Accesibilidad - Demo Interactiva</title>
    <style>
        /* estilos mínimos para demo */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.5;
            padding: 24px;
            background: #f4f6fb;
            color: #1f2937
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(20, 20, 60, 0.08)
        }

        h1 {
            color: #0f172a
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 12px 0
        }

        button,
        a,
        input,
        select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: white;
            cursor: pointer
        }

        button:focus,
        a:focus,
        input:focus,
        select:focus {
            outline: 3px solid #93c5fd;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.15)
        }

        .mutate {
            margin-top: 16px;
        }

        /* highlight regleta (widget uses same id) */
        #a11y-reading-highlight {
            position: absolute;
            background: rgba(59, 130, 246, 0.08);
            border: 2px solid rgba(59, 130, 246, 0.28);
            border-radius: 8px;
            pointer-events: none;
            transition: all 0.12s ease;
            z-index: 999999;
            display: none;
        }

        /* floating widget button placeholder */
        #a11y-toggle-btn {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 99999;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #111827;
            color: #fff;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center
        }

        #a11y-panel {
            position: fixed;
            right: 18px;
            bottom: 90px;
            width: 320px;
            max-width: 90vw;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.25);
            padding: 12px;
            display: none;
            z-index: 99999
        }

        #a11y-panel.open {
            display: block
        }

        .panel-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 8px
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Demo: Controles interactivos para el Widget</h1>
        <p>Prueba los botones, enlaces y campos. Usa <strong>Tab</strong> para navegar; presiona <strong>Enter</strong>
            o <strong>Space</strong> para activar. Observa que el widget anuncia cada interacción.</p>

        <div class="row">
            <button id="btn-submit" aria-label="Enviar formulario">Enviar</button>
            <button id="btn-open" data-a11y-label="Abrir menú">Abrir menú</button>
            <a href="#" id="link-more">Más información</a>
            <button id="btn-disabled" disabled aria-label="Botón deshabilitado">Deshabilitado</button>
        </div>

        <h3>Inputs</h3>
        <div class="row">
            <input id="name" placeholder="Nombre" />
            <input id="email" placeholder="Correo" />
            <select id="country">
                <option>Selecciona país</option>
                <option>México</option>
                <option>España</option>
            </select>
        </div>

        <h3>Contenido con control de lectura</h3>
        <p>This paragraph is in English but the site default is Spanish. Use <code>data-a11y-lang</code> to force
            language.</p>
        <p data-a11y-read="false">Este párrafo tiene <code>data-a11y-read="false"</code> y NO será leído.</p>
        <div data-a11y-lang="en">This text will be read in English.</div>

        <div class="mutate">
            <button id="add-dynamic">Agregar botón dinámico</button>
            <div id="dynamic-area"></div>
        </div>
    </div>

    <!-- highlight element (regleta) -->
    <div id="a11y-reading-highlight" aria-hidden="true"></div>

    <!-- floating toggle button and panel markup (widget will reuse) -->
    <button id="a11y-toggle-btn" aria-label="Abrir panel de accesibilidad">⚙️</button>
    <div id="a11y-panel" role="dialog" aria-labelledby="a11y-title" aria-hidden="true">
        <div style="display:flex; align-items:center; justify-content:space-between">
            <strong id="a11y-title">Accesibilidad</strong>
            <button id="a11y-close-btn" aria-label="Cerrar">✖</button>
        </div>
        <div class="panel-controls">
            <button id="a11y-read-selection">Leer selección</button>
            <button id="a11y-read-page">Leer página</button>
            <button id="a11y-stop-reading" disabled>Detener</button>
        </div>
        <div>
            <label><input type="checkbox" id="voice-cmds" /> Habilitar comandos de voz (si el navegador lo
                soporta)</label>
        </div>
    </div>

    <!-- widget script (integrado para pruebas) -->
    <script>
        (function () {
            'use strict';

            class AccessibilityWidget {
                constructor() {
                    this.isOpen = false;
                    this.currentTheme = 'default';
                    this.currentFontSize = 'medium';
                    this.isSpeaking = false;
                    this.speechSynthesis = window.speechSynthesis;
                    this.currentUtterance = null;
                    this.originalFontSize = null;
                    this.virtualFocusIndex = -1;
                    this.readableElements = [];
                    this.flowReadingActive = false;
                    this.recog = null;

                    this.init();
                }

                init() {
                    this.captureOriginalFontSize();
                    // panel & toggle already present in page; bind events
                    this.attachEventListeners();
                    this.loadPreferences();
                    this.buildReadableElementsList();
                    this.enableKeyboardNavigation();
                    // highlight exists in DOM
                    this.createReadingHighlight(); // will select existing element if present
                    this.enableVoiceCommandsToggle();
                    this.enableInteractiveDelegation();
                    this.enableAutoFocusReading();
                    this.makeEnterSpaceActivate();
                }

                captureOriginalFontSize() {
                    const computedStyle = window.getComputedStyle(document.documentElement);
                    this.originalFontSize = computedStyle.fontSize;
                }

                attachEventListeners() {
                    const toggleBtn = document.getElementById('a11y-toggle-btn');
                    const closeBtn = document.getElementById('a11y-close-btn');

                    if (toggleBtn) toggleBtn.addEventListener('click', () => this.togglePanel());
                    if (closeBtn) closeBtn.addEventListener('click', () => this.closePanel());

                    const readSel = document.getElementById('a11y-read-selection');
                    const readPage = document.getElementById('a11y-read-page');
                    const stopBtn = document.getElementById('a11y-stop-reading');

                    if (readSel) readSel.addEventListener('click', () => this.readSelection());
                    if (readPage) readPage.addEventListener('click', () => this.readPage());
                    if (stopBtn) stopBtn.addEventListener('click', () => this.stopReading());

                    // panel close via escape when open
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.isOpen) {
                            e.preventDefault();
                            this.closePanel();
                        }
                    });

                    // dynamic example: add button
                    const addBtn = document.getElementById('add-dynamic');
                    if (addBtn) addBtn.addEventListener('click', () => {
                        const area = document.getElementById('dynamic-area');
                        const b = document.createElement('button');
                        b.textContent = 'Dinámico ' + (area.children.length + 1);
                        b.setAttribute('data-a11y-label', 'Botón dinámico ' + (area.children.length + 1));
                        area.appendChild(b);
                        // update readable elements list so flow reading includes it
                        this.buildReadableElementsList();
                    });
                }

                togglePanel() {
                    const panel = document.getElementById('a11y-panel');
                    if (!panel) return;
                    this.isOpen = !this.isOpen;
                    panel.classList.toggle('open', this.isOpen);
                    panel.setAttribute('aria-hidden', (!this.isOpen).toString());
                    if (this.isOpen) {
                        document.getElementById('a11y-close-btn')?.focus();
                    } else {
                        document.getElementById('a11y-toggle-btn')?.focus();
                    }
                }

                closePanel() {
                    const panel = document.getElementById('a11y-panel');
                    if (!panel) return;
                    this.isOpen = false;
                    panel.classList.remove('open');
                    panel.setAttribute('aria-hidden', 'true');
                }

                setFontSize(size) {
                    const scales = { small: 0.875, medium: 1, large: 1.25, xlarge: 1.5 };
                    const originalSize = parseFloat(this.originalFontSize);
                    const newSize = originalSize * (scales[size] || 1);
                    document.documentElement.style.fontSize = newSize + 'px';
                    this.currentFontSize = size;
                    this.savePreferences();
                }

                savePreferences() {
                    const preferences = { fontSize: this.currentFontSize, theme: this.currentTheme };
                    localStorage.setItem('a11y-preferences', JSON.stringify(preferences));
                }

                loadPreferences() {
                    const saved = localStorage.getItem('a11y-preferences');
                    if (saved) {
                        try {
                            const p = JSON.parse(saved);
                            if (p.fontSize) this.setFontSize(p.fontSize);
                            if (p.theme) this.setTheme(p.theme);
                        } catch (e) { console.warn(e) }
                    }
                }

                setTheme(theme) {
                    document.body.classList.remove('a11y-theme-default', 'a11y-theme-dark', 'a11y-theme-high-contrast-yellow', 'a11y-theme-high-contrast-white');
                    document.body.classList.add('a11y-theme-' + theme);
                    this.currentTheme = theme;
                    this.savePreferences();
                }

                /* ---------------------------
                   Lectura - TTS básica
                ---------------------------- */
                speak(text, opts = {}) {
                    if (!this.speechSynthesis) return;
                    if (!text) return;
                    // stop previous
                    this.speechSynthesis.cancel();
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.lang = opts.lang || 'es-ES';
                    if (opts.rate) utter.rate = opts.rate;
                    utter.onstart = () => { this.isSpeaking = true; document.getElementById('a11y-stop-reading').disabled = false; };
                    utter.onend = () => { this.isSpeaking = false; document.getElementById('a11y-stop-reading').disabled = true; };
                    utter.onerror = (e) => { console.error('TTS error', e); this.isSpeaking = false; };
                    // choose a Spanish voice if possible
                    const voices = this.speechSynthesis.getVoices();
                    const v = voices.find(v => v.lang && v.lang.startsWith('es')) || voices[0];
                    if (v) utter.voice = v;
                    // small timeout to avoid Chrome queue bug
                    setTimeout(() => this.speechSynthesis.speak(utter), 120);
                }

                stopReading() {
                    this.flowReadingActive = false;
                    this.speechSynthesis?.cancel();
                    document.getElementById('a11y-reading-highlight').style.display = 'none';
                    document.getElementById('a11y-stop-reading').disabled = true;
                }

                readSelection() {
                    const sel = window.getSelection().toString().trim();
                    if (!sel) { alert('Selecciona texto primero'); return; }
                    this.speak(sel);
                }

                extractPageText() {
                    const exclude = ['script', 'style', '#a11y-panel', '#a11y-toggle-btn', '#a11y-reading-highlight'];
                    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, {
                        acceptNode: (node) => {
                            if (!node.textContent.trim()) return NodeFilter.FILTER_REJECT;
                            let p = node.parentElement;
                            while (p) {
                                if (exclude.some(s => p.matches && p.matches(s))) return NodeFilter.FILTER_REJECT;
                                p = p.parentElement;
                            }
                            return NodeFilter.FILTER_ACCEPT;
                        }
                    });
                    const texts = [];
                    let n;
                    while (n = walker.nextNode()) texts.push(n.textContent.trim());
                    return texts.join(' ').replace(/\s+/g, ' ').trim();
                }

                readPage() {
                    const text = this.extractPageText();
                    if (!text) { alert('No se encontró texto para leer'); return; }
                    this.speak(text);
                }

                /* ---------------------------
                   Build readable list & flow reading
                ---------------------------- */
                buildReadableElementsList() {
                    const selector = 'p, li, h1, h2, h3, h4, h5, h6, button, a[href], [data-a11y-readable], img[alt]';
                    const nodes = Array.from(document.querySelectorAll(selector))
                        .filter(el => el.offsetParent !== null)
                        .filter(el => el.dataset?.a11yRead !== 'false')
                        .filter(el => !el.closest('#a11y-panel')); // exclude widget
                    this.readableElements = nodes;
                }

                createReadingHighlight() {
                    // if highlight node exists we keep it, else create
                    this.highlightEl = document.getElementById('a11y-reading-highlight');
                    if (!this.highlightEl) {
                        this.highlightEl = document.createElement('div');
                        this.highlightEl.id = 'a11y-reading-highlight';
                        document.body.appendChild(this.highlightEl);
                    }
                }

                moveHighlightToElement(el) {
                    if (!el || !this.highlightEl) return;
                    const rect = el.getBoundingClientRect();
                    this.highlightEl.style.display = 'block';
                    this.highlightEl.style.top = (rect.top + window.scrollY - 6) + 'px';
                    this.highlightEl.style.left = (rect.left + window.scrollX - 6) + 'px';
                    this.highlightEl.style.width = (rect.width + 12) + 'px';
                    this.highlightEl.style.height = (rect.height + 12) + 'px';
                }

                startFlowReading() {
                    this.buildReadableElementsList();
                    this.virtualFocusIndex = 0;
                    this.flowReadingActive = true;
                    const next = () => {
                        if (!this.flowReadingActive) return;
                        if (this.virtualFocusIndex >= this.readableElements.length) {
                            this.flowReadingActive = false;
                            this.highlightEl.style.display = 'none';
                            return;
                        }
                        const el = this.readableElements[this.virtualFocusIndex];
                        if (!el) return;
                        // prepare text
                        let text = '';
                        const tag = el.tagName.toLowerCase();
                        if (tag === 'img') text = el.alt ? 'Imagen: ' + el.alt : 'Imagen sin descripción';
                        else if (/h[1-6]/.test(tag)) text = 'Encabezado ' + tag + '. ' + el.textContent.trim();
                        else text = (el.dataset?.a11yAlt || el.textContent || el.value || '').toString().trim();
                        if (!text) { this.virtualFocusIndex++; next(); return; }
                        this.moveHighlightToElement(el);
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        const utt = new SpeechSynthesisUtterance(text);
                        utt.lang = el.dataset?.a11yLang || 'es-ES';
                        utt.onend = () => { this.virtualFocusIndex++; next(); };
                        this.speechSynthesis.cancel();
                        setTimeout(() => this.speechSynthesis.speak(utt), 120);
                    };
                    next();
                }

                stopFlowReading() {
                    this.flowReadingActive = false;
                    this.speechSynthesis.cancel();
                    this.highlightEl.style.display = 'none';
                }

                /* ---------------------------
                   Interaction reading: delegation & focus
                   - use focusin for keyboard focus
                   - use document click for clicks (also works for dynamic elements)
                ---------------------------- */
                enableInteractiveDelegation() {
                    // on focusin, announce focused interactive element (if not widget)
                    document.addEventListener('focusin', (e) => {
                        const el = e.target;
                        if (!el || el.closest('#a11y-panel')) return;
                        if (this.isWidgetElement(el)) return;
                        this.announceInteractive(el);
                    }, true);

                    // on click announce clicked element (capture dynamic)
                    document.addEventListener('click', (e) => {
                        const el = e.target.closest('button, a[href], input, select, textarea, [role="button"], [tabindex]');
                        if (!el || el.closest('#a11y-panel')) return;
                        this.announceInteractive(el, { activated: true });
                    }, true);
                }

                announceInteractive(el, opts = {}) {
                    if (!el) return;
                    // allow custom label via data attribute
                    let label = el.dataset?.a11yLabel || el.getAttribute('aria-label') || el.innerText || el.value || el.title || el.alt || '';
                    label = label.toString().trim();
                    if (!label) label = el.tagName.toLowerCase();
                    // type prefix
                    const tag = el.tagName.toLowerCase();
                    const prefix = (tag === 'a') ? 'Enlace: ' : (tag === 'button' || el.getAttribute('role') === 'button') ? 'Botón: ' : '';
                    const final = (prefix + label) + (opts.activated ? ' — activado' : '');
                    // speak (short)
                    this.speak(final);
                }

                isWidgetElement(el) {
                    return !!el.closest && !!el.closest('#a11y-panel') || !!el.closest && !!el.closest('#a11y-toggle-btn');
                }

                /* ---------------------------
                   Ensure Enter/Space activates focused elements (restore native behavior)
                ---------------------------- */
                makeEnterSpaceActivate() {
                    document.addEventListener('keydown', (e) => {
                        const el = document.activeElement;
                        if (!el) return;
                        // if Enter/Space on interactive element, trigger click (but don't double-fire)
                        if ((e.key === 'Enter' || e.key === ' ') &&
                            (el.matches && (el.matches('button, a[href], [role="button"], [tabindex]:not([tabindex="-1"])') || el.tagName === 'INPUT' || el.tagName === 'SELECT'))) {
                            // allow default for inputs (space in text inputs), restrict to controls
                            const isTextInput = (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'search' || el.type === 'email' || el.type === 'url' || el.type === 'tel')) || el.tagName === 'TEXTAREA';
                            if (isTextInput && e.key === ' ') return;
                            // prevent default so page doesn't scroll on Space
                            e.preventDefault();
                            // trigger click
                            el.click();
                        }
                    }, true);
                }

                /* ---------------------------
                   Keyboard navigation for flow (Arrow keys)
                ---------------------------- */
                enableKeyboardNavigation() {
                    document.addEventListener('keydown', (e) => {
                        // Only when panel is open we intercept arrows for virtual navigation
                        if (!this.isOpen) return;
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            this.virtualFocusIndex = Math.min(this.virtualFocusIndex + 1, (this.readableElements.length || 1) - 1);
                            const el = this.readableElements[this.virtualFocusIndex];
                            if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); this.announceInteractive(el); }
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            this.virtualFocusIndex = Math.max(this.virtualFocusIndex - 1, 0);
                            const el = this.readableElements[this.virtualFocusIndex];
                            if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); this.announceInteractive(el); }
                        }
                    }, true);
                }

                /* ---------------------------
                   Auto-announce focused items (for keyboard-only users)
                ---------------------------- */
                enableAutoFocusReading() {
                    // debounced to avoid repeating redundant announcements
                    let lastAnnounced = null;
                    document.addEventListener('focusin', (e) => {
                        const el = e.target;
                        if (!el || this.isWidgetElement(el)) return;
                        const id = el.dataset?.a11yLabel || el.getAttribute('aria-label') || el.textContent?.trim() || el.value || el.tagName;
                        if (id && id === lastAnnounced) return;
                        lastAnnounced = id;
                        setTimeout(() => { this.announceInteractive(el); }, 60);
                    }, true);
                }

                /* ---------------------------
                   Voice commands toggle (basic)
                ---------------------------- */
                enableVoiceCommandsToggle() {
                    const checkbox = document.getElementById('voice-cmds');
                    if (!checkbox) return;
                    checkbox.addEventListener('change', (e) => {
                        if (checkbox.checked) this.startVoiceCommands();
                        else this.stopVoiceCommands();
                    });
                }

                startVoiceCommands() {
                    if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                        alert('Reconocimiento de voz no soportado en este navegador');
                        return;
                    }
                    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recog = new Recognition();
                    this.recog.lang = 'es-ES';
                    this.recog.continuous = true;
                    this.recog.onresult = (ev) => {
                        const last = ev.results[ev.results.length - 1][0].transcript.toLowerCase();
                        console.log('STT:', last);
                        if (last.includes('leer página')) this.startFlowReading();
                        if (last.includes('detener')) this.stopFlowReading();
                        if (last.includes('siguiente')) { this.virtualFocusIndex++; this.startFlowReading(); }
                        if (last.includes('anterior')) { this.virtualFocusIndex = Math.max(0, this.virtualFocusIndex - 1); this.startFlowReading(); }
                    };
                    this.recog.onerror = (e) => console.warn('STT error', e);
                    try { this.recog.start(); } catch (e) { console.warn(e); }
                }

                stopVoiceCommands() {
                    try { this.recog?.stop(); } catch (e) { }
                    this.recog = null;
                }
            }

            // initialize widget instance
            window.addEventListener('DOMContentLoaded', () => {
                window._A11Y_WIDGET = new AccessibilityWidget();

                // quick demo: speak a message on load so we know it's active
                setTimeout(() => window._A11Y_WIDGET.speak('Widget de accesibilidad listo. Usa Tab y Enter para probar los botones.'), 600);
            });

        })();
    </script>
</body>

</html>